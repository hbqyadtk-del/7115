<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ù†Ø¸Ø§Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ù…ÙˆØ­Ù‘Ø¯ â€” ÙˆØ§Ø¬Ù‡Ø© Ø±Ø¦ÙŠØ³ÙŠØ©</title>
<style>
  :root{
    --bg:#f7f7f7; --card:#ffffff; --text:#111;
    --accent:#0aa; --muted:#666; --danger:#ff4d4d; --good:#2e7d32;
    --glass: rgba(0,0,0,0.03);
  }
  *{box-sizing:border-box;font-family:Arial,"Noto Naskh Arabic",sans-serif}
  body{margin:0;background:var(--bg);color:var(--text);direction:rtl}
  header{padding:18px;text-align:center;border-bottom:1px solid rgba(0,0,0,0.06);background:linear-gradient(0deg,#fff, #fafafa)}
  h1{margin:0;font-size:20px}
  .wrap{padding:18px}
  /* Dashboard */
  .dash-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;max-width:900px;margin:18px auto}
  .dash-btn{background:var(--card);border:2px solid rgba(0,0,0,0.06);padding:22px;border-radius:12px;cursor:pointer; text-align:center;box-shadow:0 6px 18px var(--glass);transition:transform .12s}
  .dash-btn:hover{transform:translateY(-4px)}
  .dash-emoji{font-size:28px;display:block;margin-bottom:8px}
  .muted{color:var(--muted);font-size:13px}
  @media(max-width:760px){ .dash-grid{grid-template-columns:1fr} }

  /* Pages */
  .page{display:none;background:var(--card);padding:16px;border-radius:10px;margin:16px auto;max-width:1100px;box-shadow:0 10px 30px var(--glass)}
  .page.active{display:block}

  /* layout for inventory & sales */
  .container{display:flex;gap:16px;flex-wrap:wrap}
  .left{flex:2;min-width:280px}
  .right{flex:1;min-width:260px}
  .cat-header{padding:8px;border-radius:8px;background:linear-gradient(90deg,#f0f8f8,#f6fffb);border:1px solid rgba(0,0,0,0.04);font-weight:700;margin-bottom:8px}
  .types{display:flex;flex-wrap:wrap;gap:8px}
  .prod-btn{padding:8px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent;cursor:pointer;min-width:140px;text-align:center;transition:all .12s}
  .prod-btn:hover{box-shadow:0 6px 18px rgba(0,0,0,0.06);transform:translateY(-2px)}
  .prod-btn .small{display:block;font-size:12px;color:var(--muted);margin-top:6px}
  .prod-out{color:var(--danger);text-decoration:line-through}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border:1px solid rgba(0,0,0,0.06);text-align:center;font-size:14px}
  .btn{padding:8px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:#fff;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .client-card{padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.04);background:#fff;margin-bottom:8px}
  .search{padding:8px;border:1px solid rgba(0,0,0,0.06);width:100%;border-radius:6px}
  .flex{display:flex;gap:8px;align-items:center}
  .muted-note{color:var(--muted);font-size:12px;margin-top:8px}
</style>
</head>
<body>

<header>
  <h1>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ â€” Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
  <div class="muted">Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© â€” Ø§Ø®ØªØ± Ù‚Ø³Ù… Ù„Ù„Ø¨Ø¯Ø¡</div>
</header>

<div class="wrap">

  <!-- Dashboard -->
  <div id="dashboard" class="dash-grid">
    <div class="dash-btn" onclick="openPage('suppliersClientsPage')">
      <span class="dash-emoji">ğŸ¢ğŸ‘¥</span>
      <div style="font-weight:700">Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† & Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
      <div class="muted">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ù…ÙØ¯Ù…Ø¬ÙŠÙ†)</div>
    </div>

    <div class="dash-btn" onclick="openPage('inventoryPage')">
      <span class="dash-emoji">ğŸ“¦</span>
      <div style="font-weight:700">Ø§Ù„Ø£ØµÙ†Ø§Ù & Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
      <div class="muted">Ø¹Ø±Ø¶/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
    </div>

    <div class="dash-btn" onclick="openPage('salesPage')">
      <span class="dash-emoji">ğŸ’°</span>
      <div style="font-weight:700">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
      <div class="muted">Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© ÙˆØ®ØµÙ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</div>
    </div>

    <div class="dash-btn" onclick="openPage('invoicesPage')">
      <span class="dash-emoji">ğŸ§¾</span>
      <div style="font-weight:700">Ø§Ù„ÙÙˆØ§ØªÙŠØ±</div>
      <div class="muted">Ø¹Ø±Ø¶ ÙˆØ·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</div>
    </div>
  </div>

  <!-- Suppliers / Clients (merged) -->
  <div id="suppliersClientsPage" class="page">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 style="margin:0">Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† & Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
      <div class="flex">
        <button class="btn" onclick="openPage('dashboard')">Ø§Ù„Ø±Ø¬ÙˆØ¹</button>
      </div>
    </div>

    <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:260px">
        <h3>Ù‚Ø§Ø¦Ù…Ø© (Ù…ÙˆØ±Ø¯ÙŠÙ† + Ø¹Ù…Ù„Ø§Ø¡)</h3>
        <input id="scSearch" class="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø£Ùˆ Ù‡Ø§ØªÙ..." oninput="renderSCList()">
        <div id="scList" style="margin-top:10px"></div>
        <div class="muted-note">Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ø³ÙŠØªÙ… Ø¯Ù…Ø¬Ù‡Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù…Ù„Ù Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† (key: dataRows).</div>
      </div>

      <div style="width:360px">
        <h3>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯/Ø¹Ù…ÙŠÙ„</h3>
        <input id="scName" class="search" placeholder="Ø§Ù„Ø§Ø³Ù…">
        <input id="scPhone1" class="search" placeholder="Ø±Ù‚Ù… 1">
        <input id="scPhone2" class="search" placeholder="Ø±Ù‚Ù… 2 (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
        <input id="scEmail" class="search" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <input id="scCompany" class="search" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© (Ø¥Ù† ÙˆØ¬Ø¯)">
        <input id="scAddress" class="search" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="btn primary" onclick="addSC()">Ø­ÙØ¸</button>
          <button class="btn" onclick="clearSCForm()">Ù…Ø³Ø­</button>
        </div>
      </div>
    </div>

    <div style="margin-top:12px">
      <button class="btn" onclick="exportSC()">ØªØµØ¯ÙŠØ± JSON</button>
      <button class="btn" onclick="importSC()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
    </div>
  </div>

  <!-- Inventory Page -->
  <div id="inventoryPage" class="page">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 style="margin:0">Ø§Ù„Ø£ØµÙ†Ø§Ù Ùˆ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h2>
      <div class="flex">
        <button class="btn" onclick="openPage('dashboard')">Ø§Ù„Ø±Ø¬ÙˆØ¹</button>
        <button class="btn" onclick="openAddProduct()">Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù/Ù†ÙˆØ¹</button>
      </div>
    </div>

    <div style="margin-top:12px" class="container">
      <div class="left">
        <input id="invSearch" class="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…ØµÙ†Ù Ø£Ùˆ Ø§Ù„Ù†ÙˆØ¹..." oninput="renderInventory()">
        <div id="inventoryContainer" style="margin-top:12px"></div>
      </div>

      <div class="right">
        <h4>Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø¢Ø®Ø± Ø¥Ø¯Ø®Ø§Ù„</h4>
        <label>Ø§Ù„Ù…ØµÙ†Ù</label>
        <select id="catSelect" class="search" onchange="onCatChange()"></select>
        <div id="newCatDiv" style="display:none;margin-top:8px"><input id="newCatName" class="search" placeholder="Ø§Ø³Ù… Ù…ØµÙ†Ù Ø¬Ø¯ÙŠØ¯"></div>

        <label style="margin-top:8px">Ø§Ù„Ù†ÙˆØ¹</label>
        <select id="typeSelect" class="search" onchange="onTypeChange()"></select>
        <div id="newTypeDiv" style="display:none;margin-top:8px"><input id="newTypeName" class="search" placeholder="Ø§Ø³Ù… Ù†ÙˆØ¹ Ø¬Ø¯ÙŠØ¯"></div>

        <label style="margin-top:8px">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</label>
        <input id="purchaseInput" class="search" type="number" min="0">

        <label>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</label>
        <input id="sellInput" class="search" type="number" min="0">

        <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
        <input id="qtyInput" class="search" type="number" min="0">

        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="btn primary" onclick="saveProduct()">Ø­ÙØ¸</button>
          <button class="btn" onclick="resetAddProduct()">Ù…Ø³Ø­</button>
        </div>

        <div class="muted-note">Ø¹Ù†Ø¯ Ø­ÙØ¸ Ù…ØµÙ†Ù/Ù†ÙˆØ¹ Ø¬Ø¯ÙŠØ¯ ÙŠÙÙ†Ø´Ø£ Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ ØªØ§Ø±ÙŠØ®. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø¢Ø®Ø± Ø¥Ø¯Ø®Ø§Ù„ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù.</div>
      </div>
    </div>

    <div style="margin-top:12px">
      <button class="btn" onclick="exportCategories()">ØªØµØ¯ÙŠØ± JSON</button>
      <button class="btn" onclick="importCategories()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
    </div>
  </div>

  <!-- Sales Page -->
  <div id="salesPage" class="page">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 style="margin:0">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª â€” Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø©</h2>
      <div class="flex">
        <button class="btn" onclick="openPage('dashboard')">Ø§Ù„Ø±Ø¬ÙˆØ¹</button>
        <button class="btn" onclick="openPage('inventoryPage')">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</button>
      </div>
    </div>

    <div style="margin-top:12px" class="container">
      <div class="left">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Ø§Ù„Ù…ØµÙ†ÙØ§Øª ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
          <div>
            <button class="btn" onclick="renderInventory()">ØªØ­Ø¯ÙŠØ«</button>
          </div>
        </div>
        <div id="salesInventory" style="margin-top:10px"></div>
      </div>

      <div class="right">
        <h4>Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©</h4>
        <div style="margin-bottom:8px">
          <button class="btn" onclick="openClientSelector()">Ø§Ø®ØªØ±/Ø£Ø¶Ù Ø¹Ù…ÙŠÙ„</button>
        </div>
        <div id="chosenClientBox" class="client-card">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…ÙŠÙ„ Ø¨Ø¹Ø¯</div>

        <table>
          <thead><tr><th>Ø§Ø³Ù…</th><th>ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø±</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
          <tbody id="cartBody"></tbody>
        </table>

        <div style="margin-top:8px;font-weight:700">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ: <span id="grandTotal">0.00</span></div>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button class="btn primary" onclick="finalizeInvoice()">Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ®ØµÙ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</button>
          <button class="btn" onclick="clearCartConfirm()">ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©</button>
        </div>
        <div class="muted-note">Ø³ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ù† Ø¢Ø®Ø± Ø¥Ø¯Ø®Ø§Ù„ Ù„ÙƒÙ„ Ù†ÙˆØ¹ (Ø§Ù„Ø£Ø­Ø¯Ø«).</div>
      </div>
    </div>
  </div>

  <!-- Invoices Page -->
  <div id="invoicesPage" class="page">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 style="margin:0">Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h2>
      <div>
        <button class="btn" onclick="openPage('dashboard')">Ø§Ù„Ø±Ø¬ÙˆØ¹</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <input id="invSearch" class="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ù…Ù†ØªØ¬..." oninput="renderInvoices()">
      <div id="invoicesList" style="margin-top:12px"></div>
    </div>
  </div>

  <!-- Client selector modal (simple) -->
  <div id="clientSelector" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:90">
    <div style="background:#fff;padding:12px;border-radius:10px;box-shadow:0 16px 48px rgba(0,0,0,0.12);min-width:320px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
        <button class="btn" onclick="closeClientSelector()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div style="margin-top:8px">
        <input id="selectorSearch" class="search" placeholder="Ø§Ø¨Ø­Ø«..." oninput="renderClientSelectorList()">
        <div id="clientSelectorList" style="max-height:300px;overflow:auto;margin-top:8px"></div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="btn primary" onclick="showNewClientForm()">Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
/* ================= Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙˆÙ…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¯Ù…Ø¬ ================= */
/* Ù…ÙØ§ØªÙŠØ­ localStorage Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©:
   - categories_v2 : Ø§Ù„Ø£ØµÙ†Ø§Ù ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†
   - dataRows       : Ù…ÙˆØ±Ø¯ÙŠÙ† (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ù‚Ø¯ ØªØ®Ø²Ù† Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ù‡Ù†Ø§)
   - clients        : Ø¹Ù…Ù„Ø§Ø¡ (Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©)
   - sales_history  : Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
*/

let categories = JSON.parse(localStorage.getItem('categories_v2') || '[]');
let dataRows = JSON.parse(localStorage.getItem('dataRows') || '[]'); // Ù…ÙˆØ±Ø¯ÙŠÙ† Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙƒØ¨ÙŠØ±
let clients = JSON.parse(localStorage.getItem('clients') || '[]');
let invoices = JSON.parse(localStorage.getItem('sales_history') || '[]');

// Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„: Ø¯Ù…Ø¬ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ø¯Ø§Ø®Ù„ Ù‚Ø§Ø¦Ù…Ø© clients (ØªØ¬Ù†Ù‘Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±)
function mergeSuppliersIntoClients(){
  (dataRows||[]).forEach(s=>{
    const supplier = s.supplier || {};
    const company = s.company || {};
    const name = supplier.name || company.name || supplier.email || supplier.phone1 || ('Ù…ÙˆØ±Ø¯-'+Math.random().toString(36).slice(2,6));
    if(!clients.some(c => (c.name === name && (c.phone1 === supplier.phone1 || c.phone1 === supplier.phone2)))){
      clients.push({
        name: name,
        phone1: supplier.phone1 || '',
        phone2: supplier.phone2 || '',
        email: supplier.email || '',
        companyName: company.name || '',
        companyNum1: company.num1 || '',
        companyNum2: company.num2 || '',
        address: company.address || ''
      });
    }
  });
  localStorage.setItem('clients', JSON.stringify(clients));
}

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ù…Ø¬ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
mergeSuppliersIntoClients();

/* ====== ØªÙ†Ù‚Ù‘Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª (Dashboard / Pages) ====== */
function openPage(id){
  document.getElementById('dashboard').style.display = (id==='dashboard') ? 'grid' : 'none';
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  if(id !== 'dashboard'){
    document.getElementById(id).classList.add('active');
  } else {
    // Ø¥Ø¸Ù‡Ø§Ø± Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.getElementById('dashboard').style.display='grid';
  }
  // ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ØµÙØ­Ø§Øª Ù…Ø¹ÙŠÙ†Ø©
  if(id === 'suppliersClientsPage') renderSCList();
  if(id === 'inventoryPage') { prepareAddProduct(); renderInventory(); }
  if(id === 'salesPage') { renderSalesInventory(); renderCart(); renderChosenClient(); }
  if(id === 'invoicesPage') renderInvoices();
}

/* Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø¹Ø±Ø¶ dashboard */
openPage('dashboard');

/* ================= Ø£Ø³Ø§Ù„ÙŠØ¨ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Ø¡ (merged) ================= */
function renderSCList(){
  const q = (document.getElementById('scSearch').value||'').trim().toLowerCase();
  const area = document.getElementById('scList'); area.innerHTML = '';
  clients.forEach((c,i)=>{
    if(q && !((c.name||'').toLowerCase().includes(q) || (c.phone1||'').includes(q) || (c.phone2||'').includes(q))) return;
    const div = document.createElement('div'); div.className='client-card';
    div.innerHTML = `<div style="font-weight:800">${c.name}</div>
      <div>Ø±Ù‚Ù…1: ${c.phone1||'-'}</div>
      <div>Ø±Ù‚Ù…2: ${c.phone2||'-'}</div>
      <div>Ø§Ù„Ø¨Ø±ÙŠØ¯: ${c.email||'-'}</div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn" onclick="pickClientFromList(${i})">Ø§Ø®ØªÙŠØ§Ø±</button>
        <button class="btn" onclick="editSC(${i})">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn" onclick="deleteSC(${i})">Ø­Ø°Ù</button>
      </div>`;
    area.appendChild(div);
  });
}

function addSC(){
  const name = (document.getElementById('scName').value||'').trim();
  if(!name){ alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù…'); return; }
  const obj = {
    name, phone1: document.getElementById('scPhone1').value.trim(),
    phone2: document.getElementById('scPhone2').value.trim(), email: document.getElementById('scEmail').value.trim(),
    companyName: document.getElementById('scCompany').value.trim(), address: document.getElementById('scAddress').value.trim()
  };
  clients.push(obj);
  localStorage.setItem('clients', JSON.stringify(clients));
  clearSCForm(); renderSCList();
  alert('ØªÙ… Ø§Ù„Ø­ÙØ¸');
}
function clearSCForm(){
  ['scName','scPhone1','scPhone2','scEmail','scCompany','scAddress'].forEach(id=>document.getElementById(id).value='');
}
function editSC(i){
  const c = clients[i]; if(!c) return;
  document.getElementById('scName').value = c.name||'';
  document.getElementById('scPhone1').value = c.phone1||'';
  document.getElementById('scPhone2').value = c.phone2||'';
  document.getElementById('scEmail').value = c.email||'';
  document.getElementById('scCompany').value = c.companyName||'';
  document.getElementById('scAddress').value = c.address||'';
  // Ø­Ø°Ù Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ³ÙŠØ¹ÙŠØ¯ Ø§Ù„Ø­ÙØ¸ ÙƒØ¬Ø¯ÙŠØ¯ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø­ÙØ¸ (Ø¨Ø³ÙŠØ·)
  clients.splice(i,1); localStorage.setItem('clients', JSON.stringify(clients));
  renderSCList();
}
function deleteSC(i){
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')) return;
  clients.splice(i,1); localStorage.setItem('clients', JSON.stringify(clients)); renderSCList();
}
function exportSC(){ downloadText('clients_export.json', JSON.stringify(clients,null,2)); }
function importSC(){
  const txt = prompt('Ø§Ù„ØµÙ‚ JSON Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ (ÙŠØ­ÙÙ„ Ù…Ø­Ù„Ù‘ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©):');
  if(!txt) return;
  try{
    const arr = JSON.parse(txt);
    if(!Array.isArray(arr)) throw new Error('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…ØµÙÙˆÙØ©');
    clients = arr; localStorage.setItem('clients', JSON.stringify(clients)); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯'); renderSCList();
  } catch(e){ alert('Ø®Ø·Ø£ JSON: '+e.message) }
}

/* ================= Ø£ØµÙ†Ø§Ù / Ù…Ø®Ø²ÙˆÙ† ================= */
function saveCategories(){ localStorage.setItem('categories_v2', JSON.stringify(categories)); }

function prepareAddProduct(){
  const sels = document.getElementById('catSelect');
  sels.innerHTML = '';
  const names = categories.map(c=>c.name);
  names.forEach(n=>{
    const o = document.createElement('option'); o.value = n; o.text = n; sels.appendChild(o);
  });
  const optNew = document.createElement('option'); optNew.value = '_new_'; optNew.text='-- Ø¬Ø¯ÙŠØ¯ --'; sels.appendChild(optNew);
  sels.value = names[0] || '_new_';
  onCatChange();
}

function onCatChange(){
  const catVal = document.getElementById('catSelect').value;
  document.getElementById('newCatDiv').style.display = (catVal === '_new_') ? 'block' : 'none';
  const typeSel = document.getElementById('typeSelect'); typeSel.innerHTML='';
  if(catVal === '_new_'){ const o=document.createElement('option'); o.value='_new_'; o.text='-- Ø¬Ø¯ÙŠØ¯ --'; typeSel.appendChild(o); typeSel.value='_new_'; document.getElementById('newTypeDiv').style.display='block'; return; }
  const cat = categories.find(c=>c.name===catVal);
  if(cat){
    Object.keys(cat.types||{}).forEach(tn=>{
      const o=document.createElement('option'); o.value=tn; o.text=tn; typeSel.appendChild(o);
    });
  }
  const optNew = document.createElement('option'); optNew.value='_new_'; optNew.text='-- Ø¬Ø¯ÙŠØ¯ --'; typeSel.appendChild(optNew);
  typeSel.value = typeSel.options.length ? typeSel.options[0].value : '_new_';
  document.getElementById('newTypeDiv').style.display='none';
}
function onTypeChange(){
  document.getElementById('newTypeDiv').style.display = (document.getElementById('typeSelect').value === '_new_') ? 'block' : 'none';
}

function saveProduct(){
  let catName = document.getElementById('catSelect').value;
  const newCatName = document.getElementById('newCatName').value.trim();
  if(catName === '_new_'){
    if(!newCatName){ alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ØµÙ†Ù'); return; }
    if(categories.some(c=>c.name.toLowerCase()===newCatName.toLowerCase())){ alert('Ø§Ù„Ù…ØµÙ†Ù Ù…ÙˆØ¬ÙˆØ¯'); return; }
    catName = newCatName; categories.push({name:catName, types:{}}); 
  }
  let typeName = document.getElementById('typeSelect').value;
  const newTypeName = document.getElementById('newTypeName').value.trim();
  if(typeName === '_new_'){
    if(!newTypeName){ alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù†ÙˆØ¹'); return; }
    const cat = categories.find(c=>c.name===catName);
    if(cat && Object.keys(cat.types||{}).some(t=>t.toLowerCase()===newTypeName.toLowerCase())){ alert('Ø§Ù„Ù†ÙˆØ¹ Ù…ÙˆØ¬ÙˆØ¯'); return; }
    typeName = newTypeName;
  }
  const purchase = Number(document.getElementById('purchaseInput').value||0);
  const sell = Number(document.getElementById('sellInput').value||0);
  const qty = Number(document.getElementById('qtyInput').value||0);
  const entry = {purchase, sell, qty, datetime: new Date().toLocaleString()};
  let catObj = categories.find(c=>c.name===catName);
  if(!catObj){ catObj = {name:catName, types:{}}; categories.push(catObj); }
  if(!catObj.types[typeName]) catObj.types[typeName]=[];
  catObj.types[typeName].push(entry);
  saveCategories();
  resetAddProduct();
  renderInventory();
  alert('ØªÙ… Ø§Ù„Ø­ÙØ¸');
}

function resetAddProduct(){
  ['newCatName','newTypeName','purchaseInput','sellInput','qtyInput'].forEach(id=>document.getElementById(id).value='');
  prepareAddProduct();
}

/* Ø¹Ø±Ø¶ Ø§Ù„Ø£ØµÙ†Ø§Ù â€” Ù…Ø¹ ÙˆØ¶Ø¹ Ø®Ø· Ø£Ø­Ù…Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙØ¯ */
function renderInventory(){
  const q = (document.getElementById('invSearch')||{value:''}).value.trim().toLowerCase();
  const cont = document.getElementById('inventoryContainer'); cont.innerHTML='';
  if(!categories.length){ cont.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù.</div>'; return; }
  categories.forEach(cat=>{
    const types = Object.keys(cat.types||{});
    const matching = types.filter(tn=> !q || tn.toLowerCase().includes(q) || cat.name.toLowerCase().includes(q));
    if(!matching.length) return;
    const wrap = document.createElement('div');
    const hdr = document.createElement('div'); hdr.className='cat-header'; hdr.innerText = cat.name; wrap.appendChild(hdr);
    const box = document.createElement('div'); box.className='types';
    matching.forEach(tn=>{
      const entries = cat.types[tn]||[]; if(!entries.length) return;
      const last = entries[entries.length-1];
      const btn = document.createElement('button'); btn.className='prod-btn';
      const out = (last.qty||0) <= 0;
      if(out) btn.classList.add('prod-out');
      btn.innerHTML = `<div style="font-weight:700">${tn}</div><div class="small">Ø§Ù„ÙƒÙ…ÙŠØ©: ${last.qty||0} â€¢ Ø³Ø¹Ø±: ${last.sell||0}</div>`;
      btn.onclick = ()=> {
        if(out){ alert('Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù†ÙØ¯'); return; }
        // ÙØªØ­ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹: Ù†Ø¶Ø¹ Ø§Ù„Ù‚ÙŠÙ… ÙÙŠ Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠÙ…Ù† Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        document.getElementById('catSelect').value = cat.name; onCatChange();
        document.getElementById('typeSelect').value = tn; onTypeChange();
        document.getElementById('purchaseInput').value = last.purchase||0;
        document.getElementById('sellInput').value = last.sell||0;
        document.getElementById('qtyInput').value = last.qty||0;
      };
      box.appendChild(btn);
    });
    wrap.appendChild(box); cont.appendChild(wrap);
  });
}

/* Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ± Ø§Ù„Ø£ØµÙ†Ø§Ù */
function exportCategories(){ downloadText('categories_export.json', JSON.stringify(categories,null,2)); }
function importCategories(){
  const txt = prompt('Ø§Ù„ØµÙ‚ JSON Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù (ÙŠØ­Ù„ Ù…Ø­Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©):');
  if(!txt) return;
  try{
    const arr = JSON.parse(txt);
    if(!Array.isArray(arr)) throw new Error('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…ØµÙÙˆÙØ©');
    categories = arr; saveCategories(); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯'); renderInventory();
  }catch(e){ alert('Ø®Ø·Ø£: '+e.message) }
}

/* ================= Ù…Ø¨ÙŠØ¹Ø§Øª / Ø³Ù„Ø© ================= */
let cart = []; // {key,catName,typeName,qty,unitPrice}
let selectedClient = null;

function renderSalesInventory(){
  // Ù…Ø´Ø§Ø¨Ù‡ Ù„Ø¹Ø±Ø¶ Inventory Ù„ÙƒÙ† Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· ÙŠØ¶ÙŠÙ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø© (Ø¥Ø°Ø§ Ù…ØªÙˆÙØ±)
  const cont = document.getElementById('salesInventory'); cont.innerHTML='';
  if(!categories.length){ cont.innerHTML='<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù.</div>'; return; }
  categories.forEach(cat=>{
    const hdr = document.createElement('div'); hdr.className='cat-header'; hdr.innerText = cat.name; cont.appendChild(hdr);
    const box = document.createElement('div'); box.className='types';
    Object.keys(cat.types||{}).forEach(tn=>{
      const entries = cat.types[tn]||[]; if(!entries.length) return;
      const last = entries[entries.length-1];
      const btn = document.createElement('button'); btn.className='prod-btn';
      const out = (last.qty||0) <= 0;
      if(out) btn.classList.add('prod-out');
      btn.innerHTML = `<div style="font-weight:700">${tn}</div><div class="small">Ø§Ù„ÙƒÙ…ÙŠØ©: ${last.qty||0} â€¢ Ø³Ø¹Ø±: ${last.sell||0}</div>`;
      btn.onclick = ()=> {
        if(out){ alert('Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù†ÙØ¯'); return; }
        addToCart(cat.name, tn, last.sell);
      };
      box.appendChild(btn);
    });
    cont.appendChild(box);
  });
}

function addToCart(catName, typeName, unitPrice){
  const key = `${catName}||${typeName}`;
  const it = cart.find(x=>x.key===key);
  if(it) it.qty += 1;
  else cart.push({key,catName,typeName,qty:1,unitPrice:Number(unitPrice||0)});
  renderCart();
}

function renderCart(){
  const body = document.getElementById('cartBody'); body.innerHTML='';
  let grand=0;
  cart.forEach((it,idx)=>{
    const total = it.qty * it.unitPrice; grand += total;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${it.typeName}</td>
      <td>
        <button class="btn" onclick="changeQty(${idx},-1)">-</button>
        <span style="margin:0 8px">${it.qty}</span>
        <button class="btn" onclick="changeQty(${idx},1)">+</button>
      </td>
      <td>${it.unitPrice}</td>
      <td>${total.toFixed(2)}</td>
      <td><button class="btn" onclick="removeCartItem(${idx})">Ø­Ø°Ù</button></td>`;
    body.appendChild(tr);
  });
  document.getElementById('grandTotal').innerText = grand.toFixed(2);
  renderChosenClient();
}

function changeQty(i,delta){
  if(!cart[i]) return;
  cart[i].qty += delta;
  if(cart[i].qty <= 0) cart.splice(i,1);
  renderCart();
}
function removeCartItem(i){ cart.splice(i,1); renderCart(); }
function clearCartConfirm(){ if(!cart.length){ alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©'); return; } if(!confirm('ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©ØŸ')) return; cart=[]; renderCart(); }

function openClientSelector(){ document.getElementById('clientSelector').style.display='block'; renderClientSelectorList(); }
function closeClientSelector(){ document.getElementById('clientSelector').style.display='none'; }
function renderClientSelectorList(){
  const q = (document.getElementById('selectorSearch')||{value:''}).value.trim().toLowerCase();
  const area = document.getElementById('clientSelectorList'); area.innerHTML='';
  if(!clients.length){ area.innerHTML='<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡</div>'; return; }
  clients.forEach((c,i)=>{
    if(q && !((c.name||'').toLowerCase().includes(q) || (c.phone1||'').includes(q))) return;
    const d = document.createElement('div'); d.className='client-card';
    d.innerHTML = `<div style="font-weight:700">${c.name}</div><div>${c.phone1||''} â€” ${c.email||''}</div>
      <div style="margin-top:6px;display:flex;gap:8px">
        <button class="btn" onclick="selectClient(${i})">Ø§Ø®ØªÙŠØ§Ø±</button>
      </div>`;
    area.appendChild(d);
  });
}
function selectClient(i){ selectedClient = clients[i]; closeClientSelector(); renderChosenClient(); }
function showNewClientForm(){ closeClientSelector(); openPage('suppliersClientsPage'); document.getElementById('scName').focus(); }

// Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®ØªØ§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
function renderChosenClient(){
  const box = document.getElementById('chosenClientBox');
  if(!selectedClient){ box.innerHTML = 'Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…ÙŠÙ„ Ø¨Ø¹Ø¯'; return; }
  box.innerHTML = `<div style="font-weight:800">${selectedClient.name}</div>
    <div>${selectedClient.phone1||'-'}</div><div>${selectedClient.email||'-'}</div>`;
}
function pickClientFromList(i){ selectedClient = clients[i]; renderChosenClient(); alert('ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„'); }

/* Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© â€” Ø®ØµÙ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© */
function finalizeInvoice(){
  if(!cart.length){ alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©'); return; }
  if(!selectedClient){ alert('Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹'); return; }
  // Ø®ØµÙ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ù† Ø¢Ø®Ø± Ø¥Ø¯Ø®Ø§Ù„ Ù„ÙƒÙ„ Ù†ÙˆØ¹
  cart.forEach(it=>{
    const cat = categories.find(c=>c.name===it.catName); if(!cat) return;
    const entries = cat.types[it.typeName]; if(!entries || !entries.length) return;
    entries[entries.length-1].qty = Math.max(0, (entries[entries.length-1].qty||0) - it.qty);
  });
  saveCategories();
  // Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
  const now = new Date();
  const inv = { datetime: now.toLocaleString(), client: selectedClient, products: JSON.parse(JSON.stringify(cart)), total: cart.reduce((a,b)=>a+a+b.qty*b.unitPrice,0) };
  // correct total calc:
  inv.total = cart.reduce((a,b)=>a + b.qty*b.unitPrice, 0);
  invoices.push(inv); localStorage.setItem('sales_history', JSON.stringify(invoices));
  // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ù„Ø© Ùˆ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶
  cart = []; renderCart(); renderInventory(); renderSalesInventory();
  alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ®ØµÙ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.');
}

/* ================= ÙÙˆØ§ØªÙŠØ± ================= */
function renderInvoices(){
  const q = (document.getElementById('invSearch')||{value:''}).value.trim().toLowerCase();
  const area = document.getElementById('invoicesList'); area.innerHTML='';
  if(!invoices.length){ area.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ±.</div>'; return; }
  invoices.slice().reverse().forEach((inv, idxInv)=>{
    if(q){
      const match = (inv.client && ((inv.client.name||'').toLowerCase().includes(q) || (inv.client.phone1||'').includes(q))) ||
        inv.products.some(p=> (p.typeName||'').toLowerCase().includes(q));
      if(!match) return;
    }
    const card = document.createElement('div'); card.className='client-card';
    card.innerHTML = `<div style="font-weight:800">${inv.datetime}</div>
      <div style="margin-top:6px">Ø§Ù„Ø¹Ù…ÙŠÙ„: ${inv.client.name||'-'}</div>
      <div style="margin-top:8px"><button class="btn" onclick="viewInvoice(${invoices.length-1-idxInv})">Ø¹Ø±Ø¶ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button></div>`;
    area.appendChild(card);
  });
}
function viewInvoice(i){
  const inv = invoices[i]; if(!inv) return;
  let txt = `ØªØ§Ø±ÙŠØ®: ${inv.datetime}\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${inv.client.name}\n\nØ§Ù„Ù…Ù†ØªØ¬Ø§Øª:\n`;
  inv.products.forEach((p,j)=> txt += `${j+1}. ${p.typeName} â€” ÙƒÙ…ÙŠØ©: ${p.qty} â€” Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©: ${p.unitPrice} â€” Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${(p.qty*p.unitPrice).toFixed(2)}\n`);
  txt += `\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${inv.total.toFixed(2)}`;
  alert(txt);
}

/* ============ Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ============ */
function downloadText(filename, text){
  const a = document.createElement('a');
  const blob = new Blob([text], {type:'application/json'});
  a.href = URL.createObjectURL(blob); a.download = filename; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
}

/* ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ */
window.addEventListener('load', ()=>{
  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù…Ù† localStorage (ØªØ£ÙƒØ¯)
  categories = JSON.parse(localStorage.getItem('categories_v2') || JSON.stringify(categories));
  dataRows = JSON.parse(localStorage.getItem('dataRows') || JSON.stringify(dataRows));
  clients = JSON.parse(localStorage.getItem('clients') || JSON.stringify(clients));
  invoices = JSON.parse(localStorage.getItem('sales_history') || JSON.stringify(invoices));
  mergeSuppliersIntoClients();
  prepareAddProduct();
  renderInventory();
  renderSalesInventory();
  renderSCList();
  renderInvoices();
});
</script>

</body>
</html>
